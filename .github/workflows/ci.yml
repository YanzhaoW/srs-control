# Main Github CI pipeline to check the building and testing processes
#
# Required secrets and variables:
#
# secrets:
# - GITHUB_TOKEN: The default github token (It should be automatically created by Github).
#
# variables: none

name: ci
on:
  pull_request:
    branches:
      - dev
      - master
  push:
    branches:
      - master
  workflow_dispatch:

permissions: write-all

jobs:
  ci-test:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    strategy:
      fail-fast: false
      matrix:
        base-image: [fedora-42]
        build-type: [Debug]
        compiler: [gcc, clang, libc++]
    name: ${{ matrix.base-image }}-${{ matrix.compiler }}
    container:
      image: yanzhaowang/srs-env:${{ matrix.base-image }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 1
          submodules: 'true'
      - name: install and env vars
        run: |
          dnf upgrade -y
          dnf install -y conan nodejs hostname
          cd $GITHUB_WORKSPACE/..
          echo "PARENT_DIR=$PWD" >> $GITHUB_ENV
          echo "CONAN_HOME=$PWD/.conan2" >> $GITHUB_ENV
          if [[ ${{ matrix.compiler }} == "libc++" ]]; then
            echo "CXX=clang++" >> $GITHUB_ENV
            echo "CC=clang" >> $GITHUB_ENV
            echo "CXXFLAGS=-stdlib=libc++" >> $GITHUB_ENV
            echo "NO_ROOT=ON" >> $GITHUB_ENV
          elif [[ ${{ matrix.compiler }} == "gcc" ]]; then
            echo "CXX=g++" >> $GITHUB_ENV
            echo "CC=gcc" >> $GITHUB_ENV
            echo "NO_ROOT=OFF" >> $GITHUB_ENV
          elif [[ ${{ matrix.compiler }} == "clang" ]]; then
            echo "CXX=clang++" >> $GITHUB_ENV
            echo "CC=clang" >> $GITHUB_ENV
            echo "CXXFLAGS=-stdlib=libstdc++" >> $GITHUB_ENV
            echo "NO_ROOT=OFF" >> $GITHUB_ENV
          else
            exit 1
          fi

      - name: set env variables for cdash
        run: |
          if [[ $GITHUB_EVENT_NAME == "push" ]]; then
            echo "TEST_MODEL=Continuous" >> $GITHUB_ENV
            echo "TEST_NAME=\"${{ matrix.compiler }}-${{ matrix.build-type }} (master)\"" >> $GITHUB_ENV
          else
            echo "TEST_MODEL=Experimental" >> $GITHUB_ENV
            export PULL_NR=${{ github.event.number }}
            echo "TEST_NAME=\"${{ matrix.compiler }}-${{ matrix.build-type }} (pr.${PULL_NR})\"" >> $GITHUB_ENV
          fi

      - name: restore cache
        id: cache-restore
        uses: actions/cache/restore@v4
        with:
          path: |
            ${{ env.PARENT_DIR }}/.conan2
          key: ${{ matrix.base-image }}-${{ matrix.compiler }}-${{ matrix.build-type }}

      - name: build-test-submit
        run: |
          ctest -S test/project_ctest.cmake -VV\
            -DTEST_MODEL=${TEST_MODEL}\
            -DCTEST_CONFIGURATION_TYPE=${{ matrix.build-type }}\
            -DCTEST_BUILD_NAME="$TEST_NAME"\
            -DCTEST_SITE="Github CI/CD"\
            -DADDITIONAL_CONFIGURE_OPTIONS="-DNO_ROOT=${NO_ROOT}"\
            --output-on-failure
        # ./srs_backend_test --gtest_output=xml

      - name: test coverage
        if: github.event_name == 'push'
        run: |
          if [[ $CXX == "gcc" ]]; then
            ctest -T coverage
            ctest -T Submit
          fi

      # - name: publish test report
      #   uses: dorny/test-reporter@v1
      #   if: success() || failure()
      #   with:
      #     name: Google test
      #     path: 'build/bin/test_detail.xml'
      #     fail-on-error: true
      #     reporter: java-junit
